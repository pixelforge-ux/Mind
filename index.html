<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://developer.eitaa.com/eitaa-web-app.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  try {
    if (window.Eitaa && Eitaa.WebApp) {
      Eitaa.WebApp.ready();

      // تمام صفحه شدن
      if (Eitaa.WebApp.expand)
        Eitaa.WebApp.expand();

      // تغییر رنگ هدر به آبی مایل به سفید (ثابت)
      if (Eitaa.WebApp.setHeaderColor)
        Eitaa.WebApp.setHeaderColor('#696969');

      // تایید قبل از بستن WebApp
      if (Eitaa.WebApp.enableClosingConfirmation)
        Eitaa.WebApp.enableClosingConfirmation();

      // غیرفعال کردن سوایپ عمودی (اگر پشتیبانی شود)
      if (Eitaa.WebApp.disableVerticalSwipes)
        Eitaa.WebApp.disableVerticalSwipes();

      // دکمه بک
      Eitaa.WebApp.onEvent('backButtonClicked', () => {
        if (history.length > 1) {
          history.back();
        } else {
          Eitaa.WebApp.close();
        }
      });
    }
  } catch (e) {
    console.warn(e);
  }
});
              </script>
    <title>چهار برگ ایرانی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        #game-canvas {
            width: 100vw;
            height: 100vh;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .card {
            width: 65px;
            height: 90px;
            border-radius: 6px;
            background-size: cover;
            position: absolute;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            /* Remove CSS transition to avoid conflict with GSAP */
        }
        .card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 10px 15px rgba(0,0,0,0.4);
            z-index: 50;
        }
        .card.opponent {
            cursor: default;
            transform: rotate(180deg);
        }
        .card.opponent:hover {
            transform: rotate(180deg);
        }
        .menu-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }
        #splash-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: opacity 0.8s ease-out;
        }
        .loader-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
            position: relative;
        }
        .loader-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: #d4af37;
            width: 0%;
            transition: width 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #aa841e 100%);
            color: #1a1a1a;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .btn-primary:active {
            transform: scale(0.95);
        }
        .setting-card {
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 4px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .setting-card.active {
            border-color: #d4af37;
        }
        .score-badge {
            background: rgba(0,0,0,0.6);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid rgba(212, 175, 55, 0.4);
        }
        .sur-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            pointer-events: none;
            z-index: 100;
            opacity: 0;
        }
        #hud {
            width: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 70;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: absolute;
            top: 10px;
            left: 0;
            padding: 0 15px;
            gap: 8px;
        }
        .turn-indicator {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #d4af37;
            clip-path: polygon(50% 100%, 0% 0%, 100% 0%);
            z-index: 80;
            opacity: 0;
            filter: drop-shadow(0 0 10px #d4af37);
        }
        .hud-top-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="splash-screen">
        <img src="logo.png" alt="Logo" class="w-48 mb-6 floating">
        <h1 class="text-4xl font-bold text-yellow-500 mb-2">چهار برگ سلطنتی</h1>
        <p class="text-gray-400 text-sm mb-8">کاری از سید آروین موسوی</p>
        <div class="loader-bar">
            <div id="loader-progress" class="loader-progress"></div>
        </div>
        <p id="loading-text" class="mt-4 text-xs text-yellow-600/60 uppercase tracking-widest">در حال بارگذاری</p>
    </div>

    <div id="game-canvas" style="background-image: url('carpet_1.png');">
        <!-- Table Area -->
        <div id="table-cards" class="absolute inset-0 pointer-events-none z-10"></div>
        
        <!-- UI Overlays -->
        <div id="hud">
            <div class="hud-top-bar">
                <div id="deck-count" class="score-badge">بانک: ۵۲</div>
                <div id="game-status" class="score-badge bg-blue-900/50 border-blue-400">در حال پخش...</div>
                <button onclick="pauseGame()" class="score-badge pointer-events-auto bg-gray-800 hover:bg-gray-700 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-500"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    <span>توقف</span>
                </button>
            </div>
            <div id="scores-container" class="flex flex-wrap justify-center gap-2 w-full">
                <!-- Scores dynamic -->
            </div>
            <div id="current-turn" class="score-badge bg-yellow-600 text-black font-bold text-center min-w-[120px] shadow-lg">نوبت شما</div>
        </div>

        <div id="sur-text" class="sur-popup">سور!</div>

        <!-- Main Menu -->
        <div id="main-menu" class="absolute inset-0 menu-overlay flex flex-col items-center justify-center p-6 z-50">
            <img src="logo.png" alt="Logo" class="w-48 mb-8 floating">
            <h1 class="text-4xl font-bold mb-12 text-yellow-500">چهار برگ سلطنتی</h1>
            
            <div class="flex flex-col gap-4 w-full max-w-xs">
                <button onclick="showBotSetup()" class="btn-primary">بازی با ربات</button>
                <button onclick="showOnlineSetup()" class="btn-primary">بازی آنلاین</button>
                <button onclick="showSettings()" class="btn-primary opacity-80">تنظیمات</button>
            </div>
        </div>

        <!-- Matchmaking Screen -->
        <div id="matchmaking" class="absolute inset-0 menu-overlay flex flex-col items-center justify-center p-6 z-50 hidden">
            <div class="flex flex-col items-center">
                <div class="w-24 h-24 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mb-8"></div>
                <h2 class="text-3xl font-bold mb-2">درحال پیدا کردن بازیکنان...</h2>
                <p id="matchmaking-status" class="text-gray-400">جستجوی رقیبان مناسب...</p>
                <div id="found-players" class="mt-8 flex gap-4">
                    <!-- Found players icons -->
                </div>
            </div>
        </div>

        <!-- Online Setup Menu -->
        <div id="online-setup" class="absolute inset-0 menu-overlay flex flex-col items-center justify-center p-6 z-50 hidden">
            <h2 class="text-2xl font-bold mb-8 text-yellow-500">تنظیمات بازی آنلاین</h2>
            <div class="w-full max-w-xs flex flex-col gap-6">
                <div>
                    <label class="block mb-2 text-center">تعداد بازیکنان</label>
                    <div class="flex justify-center gap-4">
                        <button onclick="setPlayerCount(2)" id="pc-online-2" class="btn-primary px-6 border-2 border-yellow-400">۲ نفره</button>
                        <button onclick="setPlayerCount(3)" id="pc-online-3" class="btn-primary px-6 opacity-50">۳ نفره</button>
                        <button onclick="setPlayerCount(4)" id="pc-online-4" class="btn-primary px-6 opacity-50">۴ نفره</button>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="startMatchmaking()" class="btn-primary flex-1">جستجوی بازی</button>
                    <button onclick="backToMain()" class="bg-gray-700 p-3 rounded-xl">بازگشت</button>
                </div>
            </div>
        </div>

        <!-- Bot Setup Menu -->
        <div id="bot-setup" class="absolute inset-0 menu-overlay flex flex-col items-center justify-center p-6 z-50 hidden">
            <h2 class="text-2xl font-bold mb-8">تنظیمات بازی با ربات</h2>
            <div class="w-full max-w-xs flex flex-col gap-6">
                <div>
                    <label class="block mb-2 text-center">تعداد بازیکنان</label>
                    <div class="flex justify-center gap-4">
                        <button onclick="setPlayerCount(2)" id="pc-2" class="btn-primary px-6 border-2 border-yellow-400">۲ نفره</button>
                        <button onclick="setPlayerCount(3)" id="pc-3" class="btn-primary px-6 opacity-50">۳ نفره</button>
                        <button onclick="setPlayerCount(4)" id="pc-4" class="btn-primary px-6 opacity-50">۴ نفره</button>
                    </div>
                </div>
                <div>
                    <label class="block mb-2 text-center">سختی ربات</label>
                    <select id="bot-difficulty" class="w-full bg-gray-800 p-3 rounded-xl border border-yellow-600">
                        <option value="easy">آسان</option>
                        <option value="medium" selected>متوسط</option>
                        <option value="hard">حرفه‌ای</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="startGame()" class="btn-primary flex-1">شروع بازی</button>
                    <button onclick="backToMain()" class="bg-gray-700 p-3 rounded-xl">بازگشت</button>
                </div>
            </div>
        </div>

        <!-- Pause Menu -->
        <div id="pause-menu" class="absolute inset-0 menu-overlay flex flex-col items-center justify-center p-6 z-[60] hidden">
            <div id="pause-main-content" class="flex flex-col items-center justify-center w-full max-w-xs">
                <h2 class="text-3xl font-bold mb-12 text-yellow-500">بازی متوقف شد</h2>
                <div class="flex flex-col gap-4 w-full">
                    <button onclick="resumeGame()" class="btn-primary">ادامه بازی</button>
                    <button onclick="showExitConfirm()" class="bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition-all">خروج از بازی</button>
                </div>
            </div>
            
            <div id="exit-confirm-content" class=" flex flex-col items-center justify-center w-full max-w-xs bg-gray-900 p-8 rounded-3xl border border-red-500">
                <h3 class="text-xl font-bold mb-6 text-center">آیا برای خروج مطمئن هستید؟</h3>
                <p class="text-gray-400 text-sm mb-8 text-center">پیشرفت بازی فعلی ذخیره نخواهد شد.</p>
                <div class="flex gap-4 w-full">
                    <button onclick="exitGame()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 flex-1 rounded-xl">بله، خروج</button>
                    <button onclick="hideExitConfirm()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 flex-1 rounded-xl">انصراف</button>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard" class="absolute inset-0 menu-overlay flex flex-col items-center justify-center p-6 z-[100] hidden overflow-y-auto">
            <div class="bg-gray-900 border-2 border-yellow-500 rounded-3xl p-8 w-full max-w-lg shadow-2xl">
                <h2 class="text-3xl font-bold mb-6 text-center text-yellow-500">نتایج نهایی بازی</h2>
                
                <div id="leaderboard-content" class="space-y-4 mb-8">
                    <!-- Table results will go here -->
                </div>

                <button onclick="location.reload()" class="btn-primary w-full text-lg py-4">بازی دوباره</button>
            </div>
        </div>

        <!-- Settings Menu -->
        <div id="settings-menu" class="absolute inset-0 menu-overlay flex flex-col items-center justify-center p-6 z-50 hidden overflow-y-auto">
            <h2 class="text-2xl font-bold mb-8">تنظیمات گرافیک</h2>
            
            <div class="w-full max-w-md flex flex-col gap-8">
                <div>
                    <p class="mb-4 text-center">طرح پشت کارت</p>
                    <div class="grid grid-cols-3 gap-4">
                        <div onclick="setCardBack(1)" id="cb-1" class="setting-card active">
                            <img src="card_back_1.png" class="w-full rounded-lg">
                        </div>
                        <div onclick="setCardBack(2)" id="cb-2" class="setting-card">
                            <img src="card_back_2.png" class="w-full rounded-lg">
                        </div>
                        <div onclick="setCardBack(3)" id="cb-3" class="setting-card">
                            <img src="card_back_3.png" class="w-full rounded-lg">
                        </div>
                    </div>
                </div>

                <div>
                    <p class="mb-4 text-center">طرح فرش (زمینه)</p>
                    <div class="grid grid-cols-3 gap-4">
                        <div onclick="setCarpet(1)" id="cp-1" class="setting-card active">
                            <img src="carpet_1.png" class="w-full h-20 object-cover rounded-lg">
                        </div>
                        <div onclick="setCarpet(2)" id="cp-2" class="setting-card">
                            <img src="carpet_2.png" class="w-full h-20 object-cover rounded-lg">
                        </div>
                        <div onclick="setCarpet(3)" id="cp-3" class="setting-card">
                            <img src="carpet_3.png" class="w-full h-20 object-cover rounded-lg">
                        </div>
                    </div>
                </div>

                <button onclick="backToMain()" class="btn-primary w-full">ذخیره و بازگشت</button>
            </div>
        </div>

        <!-- Hands Areas -->
        <div id="player-hand" class="absolute bottom-6 left-0 right-0 h-24 pointer-events-none z-20"></div>
        <div id="opponent-hand-top" class="absolute top-6 left-0 right-0 h-24 pointer-events-none z-20"></div>
        <div id="opponent-hand-left" class="absolute left-6 top-0 bottom-0 w-24 pointer-events-none z-20"></div>
        <div id="opponent-hand-right" class="absolute right-6 top-0 bottom-0 w-24 pointer-events-none z-20"></div>

        <!-- Turn Indicator Pointer -->
        <div id="turn-ptr" class="turn-indicator"></div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "gsap": "https://esm.sh/gsap"
        }
    }
    </script>
    <script type="module" src="game.js"></script>
</body>
</html>
